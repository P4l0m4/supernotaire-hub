import Stripe from "stripe";

export const config = {
  api: {
    bodyParser: false,
  },
};

export default defineEventHandler(async (event) => {
  const runtime = useRuntimeConfig(event);
  const secret = runtime.STRIPE_SECRET_KEY;
  const webhookSecret = runtime.STRIPE_WEBHOOK_SECRET;
  if (!secret || !webhookSecret) {
    setResponseStatus(event, 400);
    return { error: "Clés Stripe manquantes." };
  }

  const stripe = new Stripe(secret, { apiVersion: "2024-12-18.acacia" });
  const signature = getHeader(event, "stripe-signature");
  const rawBody = await readRawBody(event, { encoding: "utf-8" });

  if (!signature || !rawBody) {
    setResponseStatus(event, 400);
    return { error: "Signature ou payload absent." };
  }

  try {
    const evt = stripe.webhooks.constructEvent(rawBody, signature, webhookSecret);
    if (evt.type === "checkout.session.completed") {
      // Ici on pourrait persister une preuve ou mapper la session à un utilisateur.
      console.log("[Stripe webhook] Paiement confirmé", evt.data.object.id);
    }
    return { received: true };
  } catch (err) {
    console.error("[Stripe webhook] signature invalide", err);
    setResponseStatus(event, 400);
    return { error: "Signature invalide" };
  }
});

